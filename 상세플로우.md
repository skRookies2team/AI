# 전체 시스템 아키텍처

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Frontend   │ ──▶ │   Backend   │ ──▶ │  AI Server  │
│  (React)    │ ◀── │  (Spring)   │ ◀── │  (FastAPI)  │
└─────────────┘     └─────────────┘     └─────────────┘
                          │
                          ▼
                    ┌─────────────┐
                    │   MariaDB   │
                    └─────────────┘
```

---

## AI 서버 API 엔드포인트

| 엔드포인트 | 메서드 | 설명 |
|------------|--------|------|
| `/` | GET | 상태 확인 |
| `/analyze` | POST | 소설 분석 → 게이지 제안 |
| `/analyze/file` | POST | txt 파일 업로드 → 게이지 제안 |
| `/generate` | POST | 스토리 생성 |
| `/generate/file` | POST | txt 파일로 스토리 생성 |

---

## API 요청/응답 형식

### POST /analyze
```json
// Request
{
  "novel_text": "소설 전체 텍스트..."
}

// Response
{
  "summary": "소설 요약 (500자)",
  "characters": [...],
  "gauges": [
    {
      "id": "hope",
      "name": "희망",
      "meaning": "...",
      "min_label": "절망",
      "max_label": "희망",
      "description": "...",
      "initial_value": 65
    }
  ]
}
```

### POST /generate
```json
// Request
{
  "novel_text": "소설 텍스트",
  "selected_gauge_ids": ["hope", "trust"],
  "num_episodes": 3,
  "max_depth": 3,
  "ending_config": {
    "happy": 2,
    "tragic": 1,
    "neutral": 1,
    "open": 1,
    "bad": 0,
    "bittersweet": 0
  },
  "num_episode_endings": 3
}

// Response
{
  "metadata": {...},
  "context": {...},
  "episodes": [...]
}
```

---

## 상세 파이프라인 (7단계)

### 1단계: 소설 요약 생성 (`_generate_summary`)

```
입력: 원본 소설 텍스트
      ↓
┌─────────────────────────────────────┐
│ 텍스트 길이 체크                      │
│  ├─ ≤ 20,000자: 직접 요약            │
│  └─ > 20,000자: 청크 분할 요약        │
│       ├─ 20,000자씩 분할             │
│       ├─ 각 청크 200자 요약          │
│       └─ 통합하여 500자 최종 요약     │
└─────────────────────────────────────┘
      ↓
출력: novel_summary (500자 내외)
```

**LLM 프롬프트 요청사항:**
- 핵심 줄거리
- 주제
- 갈등 구조
- 결말

---

### 2단계: 등장인물 추출 (`extract_characters`)

```
입력: 소설 텍스트 (줄번호 부착)
      ↓
┌─────────────────────────────────────┐
│ 텍스트 샘플링 (1000줄 초과 시)        │
│  ├─ 앞 400줄                        │
│  ├─ 중간 200줄                      │
│  └─ 뒤 400줄                        │
└─────────────────────────────────────┘
      ↓
LLM 분석
      ↓
출력: Character[]
```

**Character 구조:**
```json
{
  "name": "랠프",
  "aliases": ["금발의 소년", "대장"],
  "description": "금발의 소년으로 [cite: 8, 35], 만 12살입니다...",
  "relationships": [
    "잭과 리더십 문제로 대립함 [cite: 612, 892]"
  ]
}
```

---

### 3단계: 게이지 시스템 설계 (`suggest_gauges`)

```
입력: novel_summary
      ↓
LLM이 소설 테마/갈등 분석
      ↓
출력: Gauge[] (5개 제안)
      ↓
사용자가 2개 선택 (selected_gauge_ids)
```

**Gauge 구조:**
```json
{
  "id": "civilization",
  "name": "문명도",
  "meaning": "사회 질서와 규범을 유지하려는 정도",
  "min_label": "야만",
  "max_label": "질서",
  "description": "높을수록 민주적 리더십...",
  "initial_value": 65
}
```

**게이지 초기값:** AI가 소설 상황에 맞게 설정 (0~100)
- 평화로운 시작: hope = 70
- 위기 상황 시작: hope = 30

---

### 4단계: 최종 엔딩 설계 (`design_final_endings`)

```
입력: novel_summary + selected_gauges[] + ending_config
      ↓
LLM이 타입별 개수에 맞춰 엔딩 설계
      ↓
출력: FinalEnding[]
```

**ending_config (엔딩 타입별 개수 설정):**
```json
{
  "happy": 2,       // 행복한 엔딩 (희망적인 결말, 목표 달성)
  "tragic": 1,      // 비극적인 엔딩 (파멸, 죽음, 실패)
  "neutral": 1,     // 중립적인 엔딩 (무난한 결말)
  "open": 1,        // 열린 결말 (해석의 여지)
  "bad": 0,         // 나쁜 엔딩 (불행한 결말)
  "bittersweet": 0  // 씁쓸한 엔딩 (희생을 통한 성공)
}
```

**FinalEnding 구조:**
```json
{
  "id": "ending_hope",
  "type": "happy",
  "title": "구조의 희망",
  "condition": "hope >= 70 AND trust >= 60",
  "summary": "소년들은 끝까지 희망을 잃지 않고..."
}
```

**최종 엔딩 결정 방식:**
- 모든 에피소드 완료 후 누적된 게이지 값으로 condition 평가
- 조건에 맞는 엔딩으로 분기

---

### 5단계: 에피소드 분할 (`split_into_episodes`)

```
입력: novel_summary + characters[] + num_episodes
      ↓
LLM이 소설을 독립적 에피소드로 분할
      ↓
출력: episode_templates[]
```

**Episode Template 구조:**
```json
{
  "id": "ep1_encounter",
  "title": "첫 만남",
  "order": 1,
  "description": "주인공들이 처음 만나 서로를 알아가는 과정",
  "theme": "신뢰 형성",
  "key_characters": ["랠프", "잭", "피기"]
}
```

**중요 규칙:**
- 에피소드 간 스토리는 연결되지 않음 (독립적)
- 에피소드 간에는 **게이지만 누적**

---

### 6단계: 에피소드별 스토리 생성

각 에피소드마다 3개의 서브 단계 실행:

#### 6-1. 도입부 생성 (`generate_episode_intro`)

```
입력: episode_template + characters[] + novel_summary
      ↓
출력: intro_text (800~1200자)
```

**도입부 내용:**
- 현재 상황과 배경 설명
- 등장인물들의 대화와 행동
- 분위기와 감정 묘사
- 에피소드 핵심 갈등/테마 암시
- 자연스럽게 첫 선택지로 연결

---

#### 6-2. 스토리 트리 생성 (`generate_full_tree`)

**LangGraph StateGraph 사용:**

```
┌─────────────────────────────────────────────────────────┐
│                    StoryGenerationState                  │
│  ┌─────────────────────────────────────────────────┐    │
│  │ nodes: StoryNode[]        (생성된 노드 누적)      │    │
│  │ context: Dict             (캐릭터, 게이지, 엔딩)  │    │
│  │ max_depth: int            (최대 깊이)            │    │
│  │ current_gauges: Dict      (현재 게이지 상태)     │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

**트리 생성 흐름:**

```
                    [depth 0: 루트]
                    (first_choice)
                    선택지 2~4개
                   /      |      \
            [depth 1]  [depth 1]  [depth 1]
           (development)
            선택지 2~4개
           /    \
    [depth 2]  [depth 2]
    (climax)
    선택지 2~4개
       |
  [depth 3: max_depth]
    (ending)
    선택지 없음
```

**노드 타입:**
- `first_choice`: depth 0 (시작)
- `development`: 중간 depth
- `climax`: max_depth - 1
- `ending`: max_depth (선택지 없음)

**선택지 개수:** AI가 상황에 맞게 2~4개 자동 결정
- 단순한 상황, 긴박한 순간: 2개
- 일반적인 상황: 3개
- 중요한 분기점, 다양한 접근: 4개

**StoryNode 구조:**
```json
{
  "id": "a1b2c3d4",
  "depth": 1,
  "text": "스토리 본문 (500-800자)...",
  "details": {
    "npc_emotions": {"랠프": "불안", "잭": "흥분"},
    "situation": "현재 상황 한 줄 요약",
    "relations_update": {"랠프-잭": "적대감 상승"}
  },
  "choices": [
    {
      "text": "잭에게 협력을 제안한다",
      "tags": ["cooperative", "trusting"]
    },
    {
      "text": "혼자 행동하기로 결심한다",
      "tags": ["cautious", "doubtful"]
    }
  ],
  "parent_id": "root123",
  "node_type": "development",
  "episode_id": "ep1_encounter"
}
```

**선택지 태그 종류:**
| 태그 | 설명 |
|------|------|
| cooperative | 협력적 |
| aggressive | 공격적 |
| cautious | 신중한 |
| trusting | 신뢰하는 |
| doubtful | 의심하는 |
| brave | 용감한 |
| fearful | 두려워하는 |
| rational | 이성적 |
| emotional | 감정적 |

**Map-Reduce 패턴:**
```
[노드 생성] ──▶ [분기 판단] ──▶ [자식 노드들 병렬 생성]
     │              │                    │
     │              │                    ▼
     │              │         ┌───┬───┬───┐
     │              │         │   │   │   │
     │              └─────────▶ Send() Send() Send()
     │                              │
     └──────────────────────────────┘
               (반복)
```

---

#### 6-3. 에피소드 엔딩 설계 (`design_episode_endings`)

```
입력: episode_template + selected_gauges[] + num_episode_endings
      ↓
LLM이 엔딩 설계
      ↓
출력: EpisodeEnding[]
```

**EpisodeEnding 구조:**
```json
{
  "id": "ep1_ending_trust",
  "title": "신뢰의 시작",
  "condition": "cooperative >= 2 AND trusting >= 1",
  "text": "서로를 알아가며 신뢰가 싹텄다...",
  "gauge_changes": {
    "hope": 15,
    "trust": 20
  }
}
```

**게이지 변화량:** AI가 엔딩 중요도에 따라 유동적으로 설정
- 작은 영향: -10 ~ +10
- 보통 영향: -20 ~ +20
- 큰 영향 (극적인 엔딩): -30 ~ +30

**에피소드 엔딩 결정 방식:**
1. 플레이어가 선택한 선택지들의 **태그 누적**
2. 에피소드 끝에서 **condition** 평가
3. 조건에 맞는 엔딩 표시
4. **gauge_changes**로 게이지 변화 적용

---

### 7단계: 결과 저장 (`save_episode_story`)

**최종 출력 JSON 구조:**

```json
{
  "metadata": {
    "total_episodes": 3,
    "total_nodes": 45,
    "gauges": ["희망", "신뢰"],
    "character_count": 5
  },
  "context": {
    "novel_summary": "소설 요약...",
    "characters": [...],
    "gauges": [...],
    "final_endings": [...]
  },
  "episodes": [
    {
      "id": "ep1_encounter",
      "title": "첫 만남",
      "order": 1,
      "description": "...",
      "theme": "신뢰 형성",
      "intro_text": "도입부 텍스트 (800~1200자)...",
      "nodes": [
        {
          "id": "...",
          "depth": 0,
          "text": "...",
          "details": {...},
          "choices": [...],
          "parent_id": null,
          "node_type": "first_choice",
          "episode_id": "ep1_encounter"
        }
      ],
      "endings": [
        {
          "id": "ep1_ending_trust",
          "title": "신뢰의 시작",
          "condition": "cooperative >= 2",
          "text": "...",
          "gauge_changes": {"hope": 15, "trust": 20}
        }
      ]
    }
  ]
}
```

---

## 게이지 시스템 동작 요약

```
[게임 시작]
    │
    ▼
게이지 초기값 = AI가 설정한 initial_value
    │
    ▼
┌─────────────────────────────────┐
│        에피소드 1 플레이          │
│  ┌─────────────────────────┐    │
│  │ 선택지 선택 → 태그 누적    │    │
│  │ (cooperative +1 등)     │    │
│  └─────────────────────────┘    │
│              ↓                  │
│  ┌─────────────────────────┐    │
│  │ 에피소드 엔딩 결정         │    │
│  │ (태그 조건 평가)          │    │
│  └─────────────────────────┘    │
│              ↓                  │
│  ┌─────────────────────────┐    │
│  │ gauge_changes 적용       │    │
│  │ (AI가 설정한 변화량)      │    │
│  └─────────────────────────┘    │
└─────────────────────────────────┘
    │
    ▼
에피소드 2, 3... 반복
    │
    ▼
┌─────────────────────────────────┐
│     최종 게이지 값으로            │
│     FinalEnding 결정            │
│  (hope >= 70 AND trust >= 60)  │
└─────────────────────────────────┘
```

---

## 웹 연동 흐름 (S3 통합 버전)

### 📌 아키텍처 개요

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│  프론트엔드   │         │   백엔드     │         │   AWS S3    │         │  AI 서버    │
│  (React)    │ ◀─────▶ │  (Spring)   │ ◀─────▶ │   (Storage) │ ◀─────▶ │  (FastAPI)  │
└─────────────┘         └─────────────┘         └─────────────┘         └─────────────┘
                              │                                                 │
                              ▼                                                 │
                        ┌─────────────┐                                         │
                        │   MariaDB   │                                         │
                        └─────────────┘                                         │
                                                                                 │
                        ┌────────────────────────────────────────────────────────┘
                        │ ✅ AI 서버가 S3에서 직접 다운로드 (효율적!)
                        └─ 백엔드는 fileKey만 전달
```

### 🔄 1단계: 소설 업로드 및 분석

```
[프론트엔드]            [백엔드]                [S3]                  [AI 서버]
     │                     │                      │                       │
     │ 1. POST /api/novels │                      │                       │
     │    (txt 파일)        │                      │                       │
     │ ──────────────────▶ │                      │                       │
     │                     │                      │                       │
     │                     │ 2. S3 파일 업로드     │                       │
     │                     │    (MultipartFile)   │                       │
     │                     │ ──────────────────▶ │                       │
     │                     │                      │                       │
     │                     │ 3. fileKey 반환      │                       │
     │                     │    "uploads/xxx.txt" │                       │
     │                     │ ◀──────────────────│                       │
     │                     │                      │                       │
     │                     │ 4. DB 저장           │                       │
     │                     │    - s3FileKey       │                       │
     │                     │    - 기타 메타데이터   │                       │
     │                     │                      │                       │
     │                     │ 5. POST /analyze-from-s3                     │
     │                     │    {                                         │
     │                     │      "file_key": "uploads/xxx.txt",         │
     │                     │      "bucket": "story-game-bucket"          │
     │                     │    }                                         │
     │                     │ ──────────────────────────────────────────▶ │
     │                     │                      │                       │
     │                     │                      │ ◀─ 6. S3 다운로드     │
     │                     │                      │    (boto3)           │
     │                     │                      │                       │
     │                     │                      │                  [분석 중]
     │                     │                      │                  - 요약 생성
     │                     │                      │                  - 캐릭터 추출
     │                     │                      │                  - 게이지 제안
     │                     │                      │                       │
     │                     │ 7. 분석 결과 반환                             │
     │                     │    {                                         │
     │                     │      "summary": "소설 요약 500자...",         │
     │                     │      "characters": [                         │
     │                     │        {                                     │
     │                     │          "name": "랠프",                      │
     │                     │          "aliases": ["금발 소년"],            │
     │                     │          "description": "...",               │
     │                     │          "relationships": [...]              │
     │                     │        }                                     │
     │                     │      ],                                      │
     │                     │      "gauges": [                             │
     │                     │        {                                     │
     │                     │          "id": "civilization",               │
     │                     │          "name": "문명도",                    │
     │                     │          "meaning": "...",                   │
     │                     │          "min_label": "야만",                 │
     │                     │          "max_label": "질서",                 │
     │                     │          "description": "...",               │
     │                     │          "initial_value": 65                 │
     │                     │        },                                    │
     │                     │        ... (총 5개)                           │
     │                     │      ]                                       │
     │                     │    }                                         │
     │                     │ ◀──────────────────────────────────────────│
     │                     │                      │                       │
     │                     │ 8. DB 저장           │                       │
     │                     │    - 분석 결과        │                       │
     │                     │                      │                       │
     │ 9. 200 OK          │                      │                       │
     │    + 게이지 리스트   │                      │                       │
     │ ◀──────────────────│                      │                       │
     │                     │                      │                       │
     │ [게이지 선택 UI 표시] │                      │                       │
     │ - 사용자가 2개 선택  │                      │                       │
```

### 🎮 2단계: 스토리 생성

```
[프론트엔드]            [백엔드]                [S3]                  [AI 서버]
     │                     │                      │                       │
     │ 1. POST /api/generate                      │                       │
     │    {                │                      │                       │
     │      "novelId": 123,│                      │                       │
     │      "selectedGaugeIds": ["hope", "trust"],│                       │
     │      "numEpisodes": 3,                     │                       │
     │      "maxDepth": 3, │                      │                       │
     │      "endingConfig": {                     │                       │
     │        "happy": 2,  │                      │                       │
     │        "tragic": 1, │                      │                       │
     │        "neutral": 1,│                      │                       │
     │        "open": 1    │                      │                       │
     │      },             │                      │                       │
     │      "numEpisodeEndings": 3                │                       │
     │    }                │                      │                       │
     │ ──────────────────▶ │                      │                       │
     │                     │                      │                       │
     │                     │ 2. DB 조회           │                       │
     │                     │    - Novel 정보       │                       │
     │                     │    - s3FileKey 확인   │                       │
     │                     │                      │                       │
     │                     │ 3. POST /generate-from-s3                    │
     │                     │    {                                         │
     │                     │      "file_key": "uploads/xxx.txt",         │
     │                     │      "bucket": "story-game-bucket",         │
     │                     │      "selected_gauge_ids": ["hope", "trust"],│
     │                     │      "num_episodes": 3,                      │
     │                     │      "max_depth": 3,                         │
     │                     │      "ending_config": {                      │
     │                     │        "happy": 2,                           │
     │                     │        "tragic": 1,                          │
     │                     │        "neutral": 1,                         │
     │                     │        "open": 1                             │
     │                     │      },                                      │
     │                     │      "num_episode_endings": 3                │
     │                     │    }                                         │
     │                     │ ──────────────────────────────────────────▶ │
     │                     │                      │                       │
     │                     │                      │ ◀─ 4. S3 다운로드     │
     │                     │                      │    (boto3)           │
     │                     │                      │                       │
     │                     │                      │                  [생성 중]
     │                     │                      │                  (수 분 소요)
     │                     │                      │                       │
     │                     │                      │             [1단계: 요약 생성]
     │                     │                      │             [2단계: 캐릭터 추출]
     │                     │                      │             [3단계: 게이지 설계]
     │                     │                      │             [4단계: 최종 엔딩 설계]
     │                     │                      │             [5단계: 에피소드 분할]
     │                     │                      │             [6단계: 스토리 트리 생성]
     │                     │                      │               - 도입부 생성
     │                     │                      │               - LangGraph로 트리 생성
     │                     │                      │               - 에피소드 엔딩 설계
     │                     │                      │             [7단계: JSON 저장]
     │                     │                      │                       │
     │                     │                      │ ◀─ 5. 결과 S3 업로드 ✨│
     │                     │                      │    results/story_xxx.json│
     │                     │                      │                       │
     │                     │ 6. resultKey만 반환 (가벼움!) ✨              │
     │                     │    {                                         │
     │                     │      "status": "success",                    │
     │                     │      "result_key": "results/story_xxx.json", │
     │                     │      "metadata": {                           │
     │                     │        "total_episodes": 3,                  │
     │                     │        "total_nodes": 45,                    │
     │                     │        "gauges": ["희망", "신뢰"]             │
     │                     │      },                                      │
     │                     │      "bucket": "story-game-bucket"           │
     │                     │    }                                         │
     │                     │ ◀──────────────────────────────────────────│
     │                     │                      │                       │
     │                     │ 7. S3에서 다운로드 ✨ │                       │
     │                     │    (필요할 때만)      │                       │
     │                     │ ───────────────────────────────────────────▶│
     │                     │                      │                       │
     │                     │ 8. 전체 JSON 받음    │                       │
     │                     │ ◀───────────────────────────────────────────│
     │                     │                      │                       │
     │                     │ 9. DB 저장           │                       │
     │                     │    - 스토리 전체 JSON │                       │
     │                     │    - result_key      │                       │
     │                     │    - 메타데이터       │                       │
     │                     │                      │                       │
     │ 10. 200 OK         │                      │                       │
     │    {               │                      │                       │
     │      "storyId": 456,│                      │                       │
     │      "status": "completed"                 │                       │
     │    }               │                      │                       │
     │ ◀──────────────────│                      │                       │
     │                     │                      │                       │
     │ [생성 완료 UI 표시] │                      │                       │
```

### 🔑 핵심 개선 사항

#### 1. 소설 업로드 개선 (입력 최적화)

**이전 방식 (비효율적) ❌**
```
백엔드 → S3에서 다운로드 (메모리 부담)
     → novel_text를 POST /analyze로 전송 (30만자 = ~300KB 네트워크 부담)
     → AI 서버 처리
```

**현재 방식 (효율적) ✅**
```
백엔드 → fileKey만 POST /analyze-from-s3로 전송 (50바이트)
AI 서버 → S3에서 직접 다운로드 (효율적)
       → 처리
```

#### 2. 결과 반환 개선 (출력 최적화) ✨ NEW

**이전 방식 (문제 있음) ❌**
```
AI 서버 → 스토리 생성 (100-300개 노드 * 800자 = 200KB-2MB)
       → HTTP Body로 전송 (메모리 부담, 타임아웃 위험)
       → 백엔드 수신
```

**현재 방식 (최적화) ✅**
```
AI 서버 → 스토리 생성 (200KB-2MB)
       → S3에 업로드 (results/ 디렉토리)
       → resultKey만 반환 (1KB)
       → 백엔드가 필요할 때 S3에서 다운로드
```

### 💡 장점

1. **메모리 효율**: 백엔드가 대용량 파일을 메모리에 로드하지 않음
2. **네트워크 효율**:
   - 입력: fileKey만 전송 (50바이트 vs 300KB)
   - 출력: resultKey만 반환 (1KB vs 2MB)
3. **타임아웃 방지**: 대용량 HTTP 응답으로 인한 타임아웃 문제 해결
4. **확장성**: 백엔드 서버 부하 감소, 여러 인스턴스 배포 가능
5. **일관성**: S3를 단일 진실 공급원(Single Source of Truth)으로 사용
6. **하위 호환성**: 기존 엔드포인트 유지로 점진적 마이그레이션 가능

### 📊 실제 크기 비교

| 시나리오 | HTTP Body 방식 | S3 방식 |
|---------|---------------|---------|
| 소설 업로드 (30만자) | 300KB | 50B (fileKey) |
| 분석 결과 | 7KB | 7KB ✅ |
| 스토리 생성 (depth=3) | 200KB | 1KB (resultKey) |
| 스토리 생성 (depth=4) | 500KB-1.5MB | 1KB (resultKey) |
| 스토리 생성 (depth=5) | 1MB-4MB ❌ | 1KB (resultKey) |

**결론**: depth가 높을수록 S3 방식의 효율성이 극대화됨!

---

## API 엔드포인트 현황

### AI 서버 엔드포인트

| 엔드포인트 | 메서드 | 데이터 소스 | 설명 | 비고 |
|------------|--------|------------|------|------|
| `/` | GET | - | 상태 확인 | |
| `/analyze` | POST | novel_text | 소설 분석 | 기존 방식 (유지) |
| `/analyze/file` | POST | 파일 업로드 | txt 파일 분석 | 기존 방식 (유지) |
| `/analyze-from-s3` | POST | S3 fileKey | S3에서 소설 분석 | **신규 추가** ✨ |
| `/generate` | POST | novel_text | 스토리 생성 | 기존 방식 (유지) |
| `/generate/file` | POST | 파일 업로드 | txt 파일로 스토리 생성 | 기존 방식 (유지) |
| `/generate-from-s3` | POST | S3 fileKey | S3에서 스토리 생성 | **신규 추가** ✨ |

### 백엔드 엔드포인트 (참고)

| 엔드포인트 | 메서드 | 설명 |
|------------|--------|------|
| `/api/novels` | POST | 소설 파일 업로드 (S3) |
| `/api/novels/{id}/analyze` | POST | 소설 분석 요청 |
| `/api/generate` | POST | 스토리 생성 요청 |
| `/api/stories/{id}` | GET | 생성된 스토리 조회 |

---

## 역할 분담

### AI 서버 (이 프로젝트 - FastAPI)
- **S3 직접 다운로드** ✨
  - boto3를 사용해 S3에서 파일 다운로드
  - 백엔드로부터 fileKey만 받아서 처리
- **소설 분석** (요약, 캐릭터, 게이지 제안)
  - 7단계 파이프라인 실행
  - LLM(OpenAI GPT) 기반 분석
- **스토리 생성** (노드, 선택지, 엔딩)
  - LangGraph를 사용한 분기형 스토리 트리 생성
  - ending_config에 따른 엔딩 타입별 생성
- **API 제공**
  - `/analyze-from-s3`, `/generate-from-s3` (S3 방식)
  - `/analyze`, `/generate` (기존 방식 - 하위 호환성)

### 백엔드 (Spring Boot)
- **S3 파일 관리**
  - 프론트엔드로부터 받은 파일을 S3에 업로드
  - fileKey 관리 및 저장
- **프론트엔드와 통신**
  - REST API 제공
  - 파일 업로드 처리
- **AI 서버 호출**
  - `/analyze-from-s3`, `/generate-from-s3` 호출
  - fileKey만 전달 (효율적)
- **DB 저장/조회** (MariaDB)
  - 소설 메타데이터
  - 분석 결과
  - 생성된 스토리 JSON
- **게임 플레이 로직**
  - 선택지 처리
  - 태그 누적
  - 게이지 계산
  - 엔딩 분기 결정
- **사용자 세션 관리**

### 프론트엔드 (React)
- **파일 업로드 UI**
  - txt 파일 업로드
  - 백엔드로 전송
- **게이지 선택 UI**
  - AI가 제안한 5개 중 2개 선택
- **설정 UI**
  - 에피소드 개수
  - 트리 깊이
  - 엔딩 타입별 개수
- **게임 플레이 UI**
  - 스토리 읽기
  - 선택지 클릭
  - 게이지 시각화
  - 엔딩 확인

### AWS S3 (Storage)
- **파일 저장소**
  - 업로드된 소설 txt 파일 저장
  - 버킷: `story-game-bucket`
  - 리전: `ap-northeast-2` (서울)
- **접근 관리**
  - 백엔드: 파일 업로드 권한
  - AI 서버: 파일 읽기 권한
  - 동일한 AWS 계정 사용

---

## 예상 노드 수

| 깊이 (max_depth) | 예상 노드 수 | 설명 |
|------------------|-------------|------|
| 2 | ~7개 | 간단한 스토리 |
| 3 | ~15-40개 | 보통 스토리 |
| 4 | ~40-120개 | 복잡한 스토리 |
| 5 | ~100-300개 | 매우 복잡 |

※ 선택지 개수(2~4개)에 따라 기하급수적으로 증가

---

## 환경 설정 가이드

### AI 서버 설정

#### 1. 의존성 설치
```bash
pip install -r requirements.txt
```

#### 2. 환경 변수 설정 (.env)
```bash
# OpenAI API
OPENAI_API_KEY=sk-your-openai-api-key-here

# AWS S3 Configuration
AWS_ACCESS_KEY_ID=your-aws-access-key-id
AWS_SECRET_ACCESS_KEY=your-aws-secret-access-key
AWS_REGION=ap-northeast-2
AWS_S3_BUCKET=story-game-bucket
```

**⚠️ 중요: 백엔드와 동일한 AWS 계정 정보를 사용해야 합니다!**

#### 3. 서버 실행
```bash
# 개발 모드
python api.py

# 또는 uvicorn 사용
uvicorn api:app --host 0.0.0.0 --port 8000 --reload

# 프로덕션 모드
uvicorn api:app --host 0.0.0.0 --port 8000 --workers 4
```

#### 4. API 문서 확인
서버 실행 후 다음 URL에서 자동 생성된 API 문서 확인:
- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

### 백엔드 설정

#### application.yml
```yaml
# AI 서버 URL
ai-server:
  url: http://your-ai-server-domain:8000

# AWS S3 Configuration
aws:
  s3:
    bucket: story-game-bucket
    region: ap-northeast-2
  credentials:
    access-key: ${AWS_ACCESS_KEY}
    secret-key: ${AWS_SECRET_KEY}
```

### S3 버킷 설정

#### 버킷 구조
```
story-game-bucket/
├── uploads/                          # 소설 원본 파일
│   ├── user1_novel_202501.txt
│   ├── user2_novel_202501.txt
│   └── ...
└── results/                          # AI 서버 생성 결과 (대용량)
    ├── story_user1_novel_20250125_143022.json
    ├── story_user2_novel_20250125_151233.json
    └── ...
```

#### IAM 권한 설정
백엔드와 AI 서버가 사용하는 IAM 사용자/역할에 다음 권한 필요:

**백엔드:**
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject"
      ],
      "Resource": [
        "arn:aws:s3:::story-game-bucket/uploads/*",
        "arn:aws:s3:::story-game-bucket/results/*"
      ]
    }
  ]
}
```

**AI 서버 (업데이트):**
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject"
      ],
      "Resource": "arn:aws:s3:::story-game-bucket/uploads/*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject"
      ],
      "Resource": "arn:aws:s3:::story-game-bucket/results/*"
    }
  ]
}
```

**주요 변경사항:**
- AI 서버에 `s3:PutObject` 권한 추가 (results/ 디렉토리)
- 대용량 스토리 생성 결과를 HTTP Body가 아닌 S3에 저장
- 백엔드는 `result_key`만 받아서 S3에서 다운로드

---

## 배포 체크리스트

### AI 서버
- [ ] `requirements.txt` 의존성 설치 완료
- [ ] `.env` 파일에 모든 환경 변수 설정
- [ ] AWS credentials 유효성 확인
- [ ] S3 접근 권한 테스트
- [ ] OpenAI API 키 유효성 확인
- [ ] 서버 정상 실행 확인 (`GET /` 엔드포인트 테스트)

### 백엔드
- [ ] `application.yml`에 AI 서버 URL 설정
- [ ] AWS credentials 설정 (AI 서버와 동일)
- [ ] S3 버킷 생성 및 권한 설정
- [ ] MariaDB 연결 확인
- [ ] AI 서버 연결 테스트

### 통합 테스트
- [ ] 파일 업로드 → S3 저장 확인
- [ ] `/analyze-from-s3` 엔드포인트 테스트
- [ ] `/generate-from-s3` 엔드포인트 테스트
- [ ] 전체 플로우 테스트 (업로드 → 분석 → 생성)

---

## 트러블슈팅

### 문제: S3 접근 권한 오류
```
ClientError: An error occurred (AccessDenied) when calling the GetObject operation
```

**해결방법:**
1. AWS credentials가 올바르게 설정되었는지 확인
2. IAM 사용자/역할에 S3 읽기 권한이 있는지 확인
3. 버킷 이름과 리전이 정확한지 확인

### 문제: 파일 인코딩 오류
```
UnicodeDecodeError: 'utf-8' codec can't decode byte
```

**해결방법:**
- txt 파일이 UTF-8 인코딩인지 확인
- 필요시 파일을 UTF-8로 변환

### 문제: OpenAI API 타임아웃
```
TimeoutError: Request timeout
```

**해결방법:**
- 소설 파일 크기가 너무 크지 않은지 확인 (권장: 100KB 이하)
- 네트워크 연결 확인
- OpenAI API 할당량 확인

---

## 레포지토리 정보

- **AI 서버**: 현재 레포지토리
- **백엔드**: https://github.com/skRookies2team/Backend/tree/feature/kwak
- **프론트엔드**: (추가 예정)
